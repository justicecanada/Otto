{% extends 'base.html' %}
{% load i18n %}
{% load filters %}
{% load autocomplete %}
{% load static %}

{% block breadcrumb %}
  {{ block.super }}
  <li class="breadcrumb-item">
    <a href="{% url 'manage_users' %}">{% trans "Manage users" %}</a>
  </li>
  <li class="breadcrumb-item">
    <a href="{% url 'cost_dashboard' %}">{% trans "Cost dashboard" %}</a>
  </li>
{% endblock %}

{% block page_css %}
  <link rel="stylesheet"
        type="text/css"
        href="{% static 'thirdparty/css/datatables.min.css' %}">
{% endblock %}

{% block page_title %}
  {% trans "Cost dashboard" %}
{% endblock %}

{% block content_container %}
  <div id="cost-dashboard-outer">
    <div class="container py-3 px-0">
      <h2 class="mb-3 mt-2">{% trans "Cost dashboard" %}</h2>

      {# Top-line number #}
      <div class="card mb-3" style="width:fit-content;">
        <div class="card-body">
          <p class="h5 mb-2">
            {{ lead_number_title }}: <span class="text-primary">{{ lead_number }}</span>
          </p>
          <p class="h6 m-0 text-secondary">
            {{ secondary_number_title }}: <span class="text-success">{{ secondary_number }}</span>
          </p>
        </div>
      </div>

      {# Bar chart #}
      <div id="chart-container" style="max-height: 20rem;">
        <canvas id="costChart"></canvas>
      </div>
 
      {# Table of details #}
      <div class="table-responsive">
        <table class="table table-striped" id="totals">
          <thead>
            <tr>
              <th>{% trans "Date" %}</th>
              <th>{% trans "Total cost (CAD)" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for date, total_cost in daily_totals.items %}
              <tr>
                <td>
                  {% comment %}ISO date is for sorting to work properly{% endcomment %}
                  <span class="d-none">{{ date|iso_date }}</span>{{ date }}
                </td>
                <td>${{ total_cost|floatformat:2 }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    function checkUserKeydown(event) {
      return event instanceof KeyboardEvent
    }
  </script>
 
{% endblock %}

{% block page_script %}
  <script src="{% static 'thirdparty/datatables.min.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  $(document).ready(function() {
    let dataTableConfig = {
      "paginate": false,
    };
    $('#totals').DataTable(dataTableConfig);

    // Prepare data for the chart
    const labels = [
        {% for date, total_cost in daily_totals.items %}
            "{{ date }}",
        {% endfor %}
    ];

    const data = {
        labels: labels,
        datasets: [{
            label: '{% trans "Total cost ($CAD)" %}',
            data: [
                {% for date, total_cost in daily_totals.items %}
                    {{ total_cost|floatformat:2 }},
                {% endfor %}
            ],
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
        }]
    };

    // Configuration for the chart
    const config = {
        type: 'bar',
        data: data,
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    };

    // Render the chart
    const costChart = new Chart(
        document.getElementById('costChart'),
        config
    );
  });
  </script>
{% endblock %}
